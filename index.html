<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Team Sync</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <style>
        :root { --primary: #2563eb; --danger: #dc2626; --bg: #f1f5f9; --card: #ffffff; --text: #334155; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* Layout */
        header { background: var(--card); padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .main-container { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
        
        /* Components */
        .card { background: var(--card); border-radius: 12px; padding: 1rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .btn { background: var(--primary); color: white; border: none; padding: 0.8rem 1.2rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        .btn-danger { background: var(--danger); }
        .btn-outline { background: transparent; border: 1px solid #cbd5e1; color: var(--text); }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-size: 16px; }

        /* Groups Scroll */
        .group-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .group-chip { white-space: nowrap; padding: 8px 16px; background: #e2e8f0; border-radius: 20px; font-size: 0.9rem; cursor: pointer; border: 2px solid transparent; }
        .group-chip.active { background: #eff6ff; color: var(--primary); border-color: var(--primary); font-weight: bold; }

        /* Tasks */
        .task-item { border-left: 4px solid var(--primary); margin-bottom: 10px; }
        .task-meta { display: flex; gap: 10px; font-size: 0.8rem; color: #64748b; margin-top: 5px; align-items: center; }
        .avatar { width: 20px; height: 20px; border-radius: 50%; vertical-align: middle; }
        .status-pill { font-size: 10px; background: #dbeafe; color: var(--primary); padding: 2px 6px; border-radius: 4px; }

        /* Modal */
        dialog { border: none; border-radius: 12px; width: 90%; max-width: 400px; padding: 0; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        dialog::backdrop { background: rgba(0,0,0,0.4); }
        .modal-content { padding: 1.5rem; }
        
        .hidden { display: none !important; }
        .fab { position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; border-radius: 28px; background: var(--primary); color: white; border: none; font-size: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; }
    </style>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
</head>
<body>

    <div id="auth-view" style="display:flex; flex:1; flex-direction:column; justify-content:center; align-items:center; padding:2rem; text-align:center;">
        <h1>Team Sync</h1>
        <p style="color:#64748b;">Collaborative Task Manager</p>
        <button id="login-btn" class="btn" onclick="handleAuth()" disabled>Sign in with Google</button>
        <p id="install-guide" style="margin-top:20px; font-size:0.8rem; color:#94a3b8; display:none;">Add to Home Screen to install</p>
    </div>

    <div id="app-view" class="hidden">
        <header>
            <div style="font-weight:bold; font-size:1.1rem;">Team Sync</div>
            <div style="display:flex; align-items:center; gap:10px;">
                <span id="sync-status" style="font-size:0.8rem;">‚òÅÔ∏è</span>
                <img id="user-pic" src="" style="width:32px; height:32px; border-radius:50%;">
            </div>
        </header>

        <div class="main-container">
            <div>
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <small style="font-weight:bold; color:#64748b;">PROJECTS</small>
                    <small style="color:var(--primary); cursor:pointer;" onclick="openGroupModal()">+ New</small>
                </div>
                <div class="group-scroll" id="group-list">
                    </div>
            </div>

            <div id="task-container">
                <div style="text-align:center; padding:2rem; color:#94a3b8;">Select a project to view tasks</div>
            </div>
        </div>

        <button id="fab-add" class="fab hidden" onclick="openTaskModal()">+</button>
    </div>

    <dialog id="task-modal">
        <div class="modal-content">
            <h3 style="margin-top:0">New Task</h3>
            <input type="text" id="t-title" placeholder="Task Title">
            <textarea id="t-desc" rows="3" placeholder="Description"></textarea>
            <select id="t-assign">
                <option value="">Unassigned</option>
            </select>
            <input type="date" id="t-due">
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:1rem;">
                <button class="btn btn-outline" onclick="closeModal('task-modal')">Cancel</button>
                <button class="btn" onclick="saveTask()">Save</button>
            </div>
        </div>
    </dialog>

    <dialog id="group-modal">
        <div class="modal-content">
            <h3 style="margin-top:0">New Project Group</h3>
            <input type="text" id="g-name" placeholder="Project Name (e.g. Marketing)">
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:1rem;">
                <button class="btn btn-outline" onclick="closeModal('group-modal')">Cancel</button>
                <button class="btn" onclick="saveGroup()">Create</button>
            </div>
        </div>
    </dialog>

    <script>
        /* --- CONFIGURATION --- */
        // 1. SET YOUR CLIENT ID
        const CLIENT_ID = '292932461234-cu1s96jcvqcseojqpqvul266fk719ung.apps.googleusercontent.com';
        
        // 2. SET YOUR SHARED FILE ID (Create a text file in Drive, share it with team, paste ID here)
        const FILE_ID = '1hEymh3AoS4MuEuVBtuAt-KgWfOrPYbuI'; 
    
        const SCOPES = 'https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email';

        /* --- STATE --- */
        let db = { users: [], groups: [], tasks: [] };
        let currentUser = null;
        let activeGroupId = null;
        let tokenClient;

        /* --- INITIALIZATION --- */
        function init() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES,
                callback: (resp) => {
                    if (resp.error) return;
                    localStorage.setItem('g_token', resp.access_token);
                    localStorage.setItem('g_expiry', Date.now() + (resp.expires_in * 1000));
                    startApp();
                }
            });

            gapi.load('client', async () => {
                await gapi.client.init({});
                document.getElementById('login-btn').disabled = false;
                checkSession();
            });

            // Register Service Worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js');
            }
        }

        function checkSession() {
            const token = localStorage.getItem('g_token');
            const expiry = localStorage.getItem('g_expiry');
            if (token && expiry && Date.now() < expiry) {
                gapi.client.setToken({ access_token: token });
                startApp();
            }
        }

        function handleAuth() { tokenClient.requestAccessToken(); }

        async function startApp() {
            document.getElementById('auth-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            
            // Get User Profile
            try {
                const res = await gapi.client.request({ path: 'https://www.googleapis.com/oauth2/v3/userinfo' });
                currentUser = res.result;
                document.getElementById('user-pic').src = currentUser.picture;
            } catch(e) { console.error(e); }

            await sync(true); // Initial Sync
            
            // Auto-refresh every 10 seconds to keep team in sync
            setInterval(() => sync(false), 10000); 
        }

        /* --- DRIVE SYNC CORE --- */
        async function sync(isInitial = false) {
            const status = document.getElementById('sync-status');
            if(isInitial) status.innerText = "üîÑ";

            try {
                const resp = await gapi.client.request({
                    path: `https://www.googleapis.com/drive/v3/files/${FILE_ID}?alt=media`,
                    method: 'GET'
                });
                
                // Merge Logic: We just take cloud state as truth for simplicity in this setup
                const cloudDB = resp.result || {};
                db = { 
                    users: cloudDB.users || [], 
                    groups: cloudDB.groups || [], 
                    tasks: cloudDB.tasks || [] 
                };

                // Auto-register current user if new
                if (currentUser && !db.users.find(u => u.email === currentUser.email)) {
                    db.users.push({ email: currentUser.email, name: currentUser.name, pic: currentUser.picture });
                    await saveToCloud(); // Save immediately so others see me
                }

                render();
                status.innerText = "‚úÖ";
            } catch (e) {
                console.error(e);
                status.innerText = "‚ö†Ô∏è";
            }
        }

        async function saveToCloud() {
            document.getElementById('sync-status').innerText = "‚òÅÔ∏è...";
            try {
                await gapi.client.request({
                    path: `https://www.googleapis.com/upload/drive/v3/files/${FILE_ID}?uploadType=media`,
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(db)
                });
                document.getElementById('sync-status').innerText = "‚úÖ";
            } catch (e) {
                document.getElementById('sync-status').innerText = "‚ùå";
                alert("Save failed. Check internet connection.");
            }
        }

        /* --- RENDERING --- */
        function render() {
            // Render Groups
            const gList = document.getElementById('group-list');
            gList.innerHTML = db.groups.map(g => `
                <div class="group-chip ${activeGroupId === g.id ? 'active' : ''}" onclick="selectGroup(${g.id})">
                    ${g.name}
                    ${activeGroupId === g.id ? `<span onclick="deleteGroup(${g.id}, event)" style="margin-left:5px;opacity:0.6">‚úï</span>` : ''}
                </div>
            `).join('');

            // Render Tasks
            const tContainer = document.getElementById('task-container');
            const fab = document.getElementById('fab-add');

            if (!activeGroupId) {
                tContainer.innerHTML = '<div style="text-align:center;padding:2rem;color:#94a3b8;">Select a project above ‚òùÔ∏è</div>';
                fab.classList.add('hidden');
                return;
            }

            fab.classList.remove('hidden');
            const tasks = db.tasks.filter(t => t.groupId === activeGroupId);
            
            if (tasks.length === 0) {
                tContainer.innerHTML = '<div style="text-align:center;padding:2rem;color:#94a3b8;">No tasks. Tap + to add one.</div>';
            } else {
                tContainer.innerHTML = tasks.map(t => {
                    const assignee = db.users.find(u => u.email === t.assignedTo);
                    return `
                    <div class="card task-item">
                        <div style="display:flex; justify-content:space-between;">
                            <strong>${t.title}</strong>
                            <button onclick="deleteTask(${t.id})" style="color:#ef4444;background:none;border:none;font-weight:bold;">üóë</button>
                        </div>
                        <div style="color:#64748b; font-size:0.9rem; margin:5px 0;">${t.desc}</div>
                        <div class="task-meta">
                            ${assignee ? `<img src="${assignee.pic}" class="avatar"> ${assignee.name.split(' ')[0]}` : '<span class="status-pill">Unassigned</span>'}
                            ${t.due ? `<span>üìÖ ${t.due}</span>` : ''}
                        </div>
                    </div>
                `}).join('');
            }
        }

        /* --- ACTIONS --- */
        function selectGroup(id) { activeGroupId = id; render(); }
        
        async function saveGroup() {
            const name = document.getElementById('g-name').value;
            if(!name) return;
            // Refresh before write to minimize conflicts
            await sync(); 
            db.groups.push({ id: Date.now(), name });
            document.getElementById('g-name').value = '';
            closeModal('group-modal');
            saveToCloud();
            render();
        }

        async function deleteGroup(id, e) {
            e.stopPropagation();
            if(!confirm("Delete group and all tasks?")) return;
            await sync();
            db.groups = db.groups.filter(g => g.id !== id);
            db.tasks = db.tasks.filter(t => t.groupId !== id);
            activeGroupId = null;
            saveToCloud();
            render();
        }

        async function saveTask() {
            const title = document.getElementById('t-title').value;
            if(!title) return;
            
            const task = {
                id: Date.now(),
                groupId: activeGroupId,
                title: title,
                desc: document.getElementById('t-desc').value,
                assignedTo: document.getElementById('t-assign').value,
                due: document.getElementById('t-due').value
            };

            await sync(); // Refresh first
            db.tasks.push(task);
            
            // Cleanup
            document.getElementById('t-title').value = '';
            document.getElementById('t-desc').value = '';
            closeModal('task-modal');
            saveToCloud();
            render();
        }

        async function deleteTask(id) {
            if(!confirm("Complete this task?")) return;
            await sync();
            db.tasks = db.tasks.filter(t => t.id !== id);
            saveToCloud();
            render();
        }

        /* --- MODAL UTILS --- */
        function openGroupModal() { document.getElementById('group-modal').showModal(); }
        function closeModal(id) { document.getElementById(id).close(); }
        function openTaskModal() {
            const sel = document.getElementById('t-assign');
            sel.innerHTML = '<option value="">Unassigned</option>' + 
                db.users.map(u => `<option value="${u.email}">${u.name}</option>`).join('');
            document.getElementById('task-modal').showModal();
        }

        /* --- BOOTSTRAP --- */
        const timer = setInterval(() => {
            if (typeof google !== 'undefined' && typeof gapi !== 'undefined') {
                clearInterval(timer);
                init();
            }
        }, 100);
    </script>
</body>
</html>