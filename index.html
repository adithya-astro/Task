<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Team Task Sync</title>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; --bg: #f8f9fa; }
        body { font-family: system-ui; background: var(--bg); margin: 0; display: flex; flex-direction: column; min-height: 100vh; }
        #status-bar { background: #333; color: white; padding: 12px; text-align: center; font-size: 13px; sticky; top: 0; }
        .container { padding: 15px; max-width: 500px; margin: 0 auto; width: 100%; box-sizing: border-box; flex-grow: 1; }
        .card { background: white; padding: 20px; border-radius: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .task-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; }
        .task-item:last-child { border-bottom: none; }
        input[type="text"] { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 10px; font-size: 16px; }
        .btn { padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; }
        .btn-add { background: var(--primary); color: white; }
        .btn-sync { background: var(--success); color: white; margin-top: 10px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="status-bar">Connecting Team Cloud...</div>

<div class="container">
    <div id="auth-view" class="card" style="text-align: center;">
        <h2>Team Task Manager</h2>
        <button class="btn btn-add" onclick="handleAuth()">Login with Google</button>
    </div>

    <div id="app-view" class="hidden">
        <div class="card">
            <input type="text" id="taskInput" placeholder="Enter new task...">
            <button class="btn btn-add" onclick="addTask()">+ Add Team Task</button>
        </div>

        <div class="card">
            <h3>Active Tasks</h3>
            <div id="taskList"></div>
            <button class="btn btn-sync" onclick="syncFromDrive()">ðŸ”„ Refresh List</button>
        </div>
    </div>
</div>

<script>
    const CLIENT_ID = 'YOUR_CLIENT_ID_HERE.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    let teamTasks = [];
    let driveFileId = null;
    let tokenClient;

    function gapiLoaded() { gapi.load('client', () => gapi.client.init({})); }
    function gisLoaded() { 
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID, scope: SCOPES,
            callback: (resp) => {
                localStorage.setItem('g_token', resp.access_token);
                startApp();
            },
        });
        if (localStorage.getItem('g_token')) startApp();
    }

    function handleAuth() { tokenClient.requestAccessToken({prompt: 'consent'}); }

    async function startApp() {
        document.getElementById('auth-view').classList.add('hidden');
        document.getElementById('app-view').classList.remove('hidden');
        await syncFromDrive();
    }

    async function syncFromDrive() {
        const bar = document.getElementById('status-bar');
        bar.innerText = "ðŸ”„ Syncing Team Data...";
        const response = await gapi.client.request({
            path: 'https://www.googleapis.com/drive/v3/files',
            params: { q: "name = 'team_tasks_shared.json' and trashed = false" }
        });
        const files = response.result.files;
        if (files && files.length > 0) {
            driveFileId = files[0].id;
            const content = await gapi.client.request({
                path: `https://www.googleapis.com/drive/v3/files/${driveFileId}`,
                params: { alt: 'media' }
            });
            teamTasks = content.result || [];
            renderTasks();
        }
        bar.innerText = "âœ… Team Synced";
    }

    function addTask() {
        const input = document.getElementById('taskInput');
        if (!input.value) return;
        teamTasks.push({ id: Date.now(), text: input.value, user: "Team Member" });
        input.value = "";
        renderTasks();
        saveToDrive();
    }

    async function saveToDrive() {
        const metadata = { name: 'team_tasks_shared.json', mimeType: 'application/json' };
        const content = JSON.stringify(teamTasks);
        const boundary = 'task_boundary';
        let url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
        let method = 'POST';
        if (driveFileId) { url = `https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=multipart`; method = 'PATCH'; }

        const body = `--${boundary}\nContent-Type: application/json; charset=UTF-8\n\n${JSON.stringify(metadata)}\n` +
                     `--${boundary}\nContent-Type: application/json\n\n${content}\n--${boundary}--`;

        await gapi.client.request({
            path: url, method: method,
            headers: { 'Content-Type': `multipart/related; boundary=${boundary}` },
            body: body
        });
        document.getElementById('status-bar').innerText = "âœ… Cloud Updated";
    }

    function renderTasks() {
        const list = document.getElementById('taskList');
        list.innerHTML = teamTasks.map(t => `
            <div class="task-item">
                <span>${t.text}</span>
                <button onclick="deleteTask(${t.id})" style="color:red; background:none; border:none;">X</button>
            </div>
        `).join('');
    }

    function deleteTask(id) {
        teamTasks = teamTasks.filter(t => t.id !== id);
        renderTasks();
        saveToDrive();
    }
</script>
</body>
</html>